<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>My Dashboard - Nexus Bank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="style.css">
</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-dark bg-dark py-3">
        <div class="container">
            <a class="navbar-brand logo-brand h1 m-0" href="#">
                <span>●</span> Nexus<span>Bank</span>
            </a>
            <div class="d-flex align-items-center">
                <div class="text-white me-3 d-none d-md-block">
                    <small class="text-muted d-block">Welcome back,</small>
                    <span id="userName" class="fw-bold">Loading...</span>
                </div>
                <button onclick="logout()" class="btn btn-outline-light btn-sm">
                    <i class="bi bi-box-arrow-right"></i> Logout
                </button>
            </div>
        </div>
    </nav>

    <div class="container mt-5">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark">My Accounts</h3>
            <button class="btn btn-primary" onclick="createAccount()">
                <i class="bi bi-plus-lg"></i> New Account
            </button>
        </div>

        <div class="card border-warning mb-4 shadow-sm" style="max-width: 400px;">
            <div class="card-header bg-warning text-dark fw-bold">
                <i class="bi bi-info-circle-fill me-1"></i> Demo Recipient Data
            </div>
            <div class="card-body bg-light py-2">
                <p class="card-text small mb-0">
                    Use these details to test a transfer to another user:
                </p>
                <hr class="my-2">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <strong>Name:</strong> Fabiana Rossetto<br>
                        <strong>National ID:</strong> <span class="user-select-all font-monospace fs-6">35102999</span>
                    </div>
                    <i class="bi bi-wallet2 text-muted fs-2"></i>
                </div>
            </div>
        </div>



        <div id="accounts-container" class="row">
            <div class="col-12 text-center text-muted">Loading accounts...</div>
        </div>

        <hr class="my-5 opacity-25">

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="fw-bold text-dark">My Cards</h3>
            <button class="btn btn-outline-dark" onclick="createCard()">
                <i class="bi bi-credit-card"></i> Request Card
            </button>
        </div>

        <div id="cards-container" class="row">
            <div class="col-12 text-center text-muted">No cards found.</div>
        </div>

        <div class="row mt-5">
            <div class="col-12">
                <h3 class="fw-bold text-dark mb-4">Transfer History</h3>
                <div class="card shadow-sm p-4">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>To (Owner)</th>
                                    <th>Amount</th>
                                </tr>
                            </thead>
                            <tbody id="history-rows">
                                <tr>
                                    <td colspan="4" class="text-center text-muted">Loading...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-5">
            <div class="col-12">
                <div class="card p-4 shadow-sm">
                    <h4 class="fw-bold mb-3">Profile Settings</h4>

                    <div class="row g-3">
                        <div class="col-md-5">
                            <label class="form-label text-muted small">First Name</label>
                            <input type="text" id="editFirstName" class="form-control">
                        </div>
                        <div class="col-md-5">
                            <label class="form-label text-muted small">Last Name</label>
                            <input type="text" id="editLastName" class="form-control">
                        </div>

                        <div class="col-md-2 d-flex align-items-end">
                            <button onclick="updateUser()" class="btn btn-dark w-100">
                                <i class="bi bi-save"></i> Save
                            </button>
                        </div>
                    </div>

                    <hr class="my-4 opacity-25">

                    <div class="d-flex justify-content-between align-items-center">
                        <div class="text-danger small fw-bold">DANGER ZONE</div>
                        <button onclick="deactivateUser()" class="btn btn-outline-danger btn-sm">
                            <i class="bi bi-person-x"></i> Deactivate My Account
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <script>

        const API_URL = "https://overall-jan-fabiana-rossetto-a47630af.koyeb.app";

        document.addEventListener('DOMContentLoaded', () => {
            loadData();
        });

        function loadData() {
            const token = localStorage.getItem('token');
            if (!token) {
                window.location.href = "index.html";
                return;
            }

            fetch(API_URL + '/api/users/current', {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(res => {
                    if (!res.ok) throw new Error("Status: " + res.status);
                    return res.json();
                })
                .then(data => {
                    console.log("USER DATA:", data);

                    // ==========================================
                    // 1. UPDATE HEADER & PROFILE INPUTS 
                    // ==========================================
                    const firstName = data.firstName || "User";
                    const lastName = data.lastName || "";

                    // Header Name
                    const userNameElement = document.getElementById('userName');
                    if (userNameElement) userNameElement.textContent = `${firstName} ${lastName}`;

                    // Profile Edit Inputs
                    const inputFirst = document.getElementById('editFirstName');
                    const inputLast = document.getElementById('editLastName');
                    if (inputFirst) inputFirst.value = firstName;
                    if (inputLast) inputLast.value = lastName;

                    // ==========================================
                    // 2. PREPARE ACCOUNTS 
                    // ==========================================
                    const accountList = [];
                    let myAccountNumber = null;
                    if (data.account) {
                        accountList.push(data.account);
                        myAccountNumber = data.account.number;
                    }
                    renderAccounts(accountList);

                    // ==========================================
                    // 3. PREPARE CARDS
                    // ==========================================
                    const cardList = [];
                    // Add Debit Card if exists
                    if (data.debitCard && data.debitCard.id) {
                        data.debitCard.type = "DEBIT";
                        cardList.push(data.debitCard);
                    }
                    // Add Credit Card if exists
                    if (data.creditCard && data.creditCard.id) {
                        data.creditCard.type = "CREDIT";
                        cardList.push(data.creditCard);
                    }

                    renderCards(cardList);
                    // ==========================================
                    // 4. LOAD TRANSFER HISTORY 
                    // ==========================================

                    if (myAccountNumber) {
                        loadTransferHistory(myAccountNumber);
                    }

                })
                .catch(error => {
                    console.error(error);

                });
        }

        function renderAccounts(accounts) {
            const container = document.getElementById('accounts-container');
            if (!container) return;
            container.innerHTML = '';

            if (!accounts || accounts.length === 0) {
                container.innerHTML = '<div class="alert alert-warning">No accounts found.</div>';
                return;
            }


            let html = '';
            accounts.forEach(acc => {
                html += `
        <div class="col-md-6 mb-4">
            <div class="card p-3 shadow-sm border-orange h-100">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="fw-bold m-0">${acc.number}</h5>
                    <span class="badge bg-success">$${acc.balance.toFixed(2)}</span>
                </div>
                <small class="text-muted">Created: ${acc.creationDate ? acc.creationDate.slice(0, 10) : 'Recent'}</small>
                
                <hr>
                
                <div class="d-flex gap-2 justify-content-between mb-3">
                <button onclick="handleDeposit()" class="btn btn-sm btn-outline-success flex-fill">Deposit</button>
                <button onclick="handleWithdraw()" class="btn btn-sm btn-outline-warning flex-fill">Withdraw</button>
                <button onclick="handleTransfer()" class="btn btn-sm btn-outline-primary flex-fill">Transfer</button>
                </div>

               <div class="d-grid">
                 <button onclick="deleteAccount(${acc.id})" class="btn btn-sm btn-danger opacity-75">
                 Delete Account
                 </button>
                </div>
            </div>
        </div>`;
            });
            container.innerHTML = html;
        }

        function createCard() {
            // 1. Ask for Card Type
            let typeInput = prompt("Enter Card Type (DEBIT or CREDIT):");
            if (!typeInput) return;

            // Normalize to UpperCase for Java
            const type = typeInput.toUpperCase().trim();
            if (type !== "DEBIT" && type !== "CREDIT") {
                return alert("Invalid type. Please type exactly DEBIT or CREDIT.");
            }

            // 2. Ask for PIN
            const pin = prompt("Enter a 4-digit PIN:");
            if (!pin || pin.length !== 4 || isNaN(pin)) {
                return alert("Invalid PIN. It must be exactly 4 digits.");
            }

            const token = localStorage.getItem('token');

            // 3. Prepare Parameters 
            const params = new URLSearchParams();
            params.append('type', type);
            params.append('pin', pin);

            // 4. Send Request
            fetch(API_URL + '/api/cards/create', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },
                body: params
            })
                .then(async response => {

                    const msg = await response.text();

                    if (response.ok) {
                        alert("Success! " + msg);
                        loadData(); // Reload to see the new card
                    } else {

                        console.error("Backend Error:", msg);
                        alert("Failed: " + msg);
                    }
                })
                .catch(error => {
                    console.error("Network Error:", error);
                    alert("Connection Error. Check console for details.");
                });
        }
        function createAccount() {
            const token = localStorage.getItem('token');
            if (!confirm("Create a new account?")) return;

            fetch(API_URL + '/api/accounts/create', {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/x-www-form-urlencoded'
                }
            }).then(res => {
                if (res.status === 201 || res.status === 200) {
                    alert("Account created!");
                    loadData();
                } else {
                    res.text().then(msg => alert("Error: " + msg));
                }
            });
        }
        function renderCards(cards) {
            const container = document.getElementById('cards-container');
            if (!container) return;

            if (!cards || cards.length === 0) {
                container.innerHTML = '<div class="col-12"><p class="text-muted">You don\'t have any cards yet.</p></div>';
                return;
            }

            let html = '';
            cards.forEach(card => {
                const bgClass = card.color === 'GOLD' ? 'bg-warning text-dark' : 'bg-dark text-white';
                const cardNum = card.number ? card.number.slice(-4) : '0000';
                const expDate = card.thruDate ? card.thruDate.slice(2, 7) : 'N/A';

               
                let limitInfo = '';
                if (card.type === 'CREDIT') {
                  
                    const limit = card.maxLimit || 0;
                    limitInfo = `
                <div class="mt-2 pt-2 border-top border-secondary small d-flex justify-content-between">
                    <span>Limit: $${limit}</span>
                </div>
            `;
                }
                // -------------------------------------------------------------

                html += `
        <div class="col-md-4 mb-4">
            <div class="card card-custom ${bgClass} p-3 shadow-sm" style="min-height: 220px; justify-content: space-between;">
                <div class="d-flex justify-content-between">
                    <span class="fw-bold">${card.type}</span>
                    <span class="badge bg-light text-dark shadow-sm">${card.color || 'SILVER'}</span>
                </div>
                
                <div class="text-center my-3">
                    <h5 class="ls-2" style="letter-spacing: 2px;">**** **** **** ${cardNum}</h5>
                </div>
                
                <div class="d-flex justify-content-between small mb-1">
                    <span>${card.cardHolder}</span>
                    <span>Exp: ${expDate}</span> 
                </div>

                ${limitInfo} <div class="d-grid gap-2 mt-3">
                    <button onclick="changeCardPin(${card.id})" class="btn btn-sm btn-light opacity-75">
                        <i class="bi bi-key"></i> Change PIN
                    </button>
                    <button onclick="deleteCard(${card.id})" class="btn btn-sm btn-danger opacity-75">
                        <i class="bi bi-trash"></i> Delete Card
                    </button>
                </div>
            </div>
        </div>
        `;
            });
            container.innerHTML = html;
        }


        // --- DELETE FUNCTIONS ---


        function deleteAccount(id) {
            if (!confirm("WARNING: This will delete the account and all its funds. Continue?")) return;

            const token = localStorage.getItem('token');
            fetch(`${API_URL}/api/accounts/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Account deleted.");
                        loadData();
                    } else {
                        res.text().then(text => alert("Error: " + text));
                    }
                })
                .catch(err => alert("Connection error"));
        }
        // DELETE CARD (Hard Delete)
        function deleteCard(id) {
            if (!confirm("Are you sure you want to delete this card? This cannot be undone.")) return;

            const token = localStorage.getItem('token');


            fetch(`${API_URL}/api/cards/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Card deleted.");
                        loadData();
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                });
        }

        // CHANGE PIN
        function changeCardPin(cardId) {
            const oldPin = prompt("Enter your CURRENT PIN:");
            if (!oldPin) return;

            const newPin = prompt("Enter your NEW PIN (4 digits):");
            if (!newPin || newPin.length !== 4) return alert("Invalid New PIN");

            const token = localStorage.getItem('token');


            fetch(API_URL + '/api/cards/update-pin', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },

                body: `cardId=${cardId}&oldPin=${oldPin}&newPin=${newPin}`
            })
                .then(res => {
                    if (res.ok) {
                        alert("PIN updated successfully.");
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                });
        }

        // --- TRANSACTION FUNCTIONS ---

        // 1. DEPOSIT (Only asks for Amount)
        function handleDeposit() {
            const amount = prompt("Enter amount to deposit:");
            if (!amount || isNaN(amount) || amount <= 0) return alert("Invalid amount");

            const token = localStorage.getItem('token');


            fetch(API_URL + '/api/accounts/deposit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },
                body: `amount=${amount}`
            }).then(res => {
                if (res.ok) {
                    alert("Deposit successful");
                    loadData();
                } else {
                    res.text().then(msg => alert("Error: " + msg));
                }
            });
        }

        // 2. WITHDRAW (Only asks for Amount)
        function handleWithdraw() {
            const amount = prompt("Enter amount to withdraw:");
            if (!amount || isNaN(amount) || amount <= 0) return alert("Invalid amount");

            const token = localStorage.getItem('token');


            fetch(API_URL + '/api/accounts/withdraw', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },
                body: `amount=${amount}`
            }).then(res => {
                if (res.ok) {
                    alert("Withdrawal successful");
                    loadData();
                } else {
                    res.text().then(msg => alert("Error: " + msg));
                }
            });
        }

        // 3. TRANSFER (Asks for Amount and DNI)
        function handleTransfer() {
            const destinationDni = prompt("Enter destination ID (DNI):");
            if (!destinationDni) return;

            const amount = prompt("Enter amount to transfer:");
            if (!amount || isNaN(amount) || amount <= 0) return alert("Invalid amount");

            const token = localStorage.getItem('token');


            fetch(API_URL + '/api/transfers/execute', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Authorization': 'Bearer ' + token
                },

                body: `amount=${amount}&destinationDni=${destinationDni}`
            }).then(res => {
                if (res.ok) {
                    alert("Transfer successful");
                    loadData();
                } else {
                    res.text().then(msg => alert("Error: " + msg));
                }
            });
        }

        // --- UPDATE USER PROFILE ---
        function updateUser() {
            const firstName = document.getElementById('editFirstName').value;
            const lastName = document.getElementById('editLastName').value;

            if (!firstName && !lastName) return alert("Nothing to update.");

            const token = localStorage.getItem('token');


            const params = new URLSearchParams();
            if (firstName) params.append('firstName', firstName);
            if (lastName) params.append('lastName', lastName);


            fetch(API_URL + '/api/users/me/update?' + params.toString(), {
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Profile updated successfully!");
                        loadData();
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                })
                .catch(err => alert("Connection error"));
        }

        // --- DEACTIVATE ACCOUNT ---
        function deactivateUser() {
            const confirmation = confirm("WARNING: Are you sure you want to deactivate your account? You will be logged out.");
            if (!confirmation) return;

            const token = localStorage.getItem('token');


            fetch(API_URL + '/api/users/me/deactivate', {
                method: 'PATCH',
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Account deactivated. Goodbye.");
                        logout(); // Log out immediately
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                })
                .catch(err => alert("Connection error"));
        }
        function logout() {
            localStorage.removeItem('token');
            window.location.href = "index.html";
        }


        function loadTransferHistory(myAccountNumber) {
            const token = localStorage.getItem('token');

            fetch(API_URL + '/api/transfers/history', {
                method: 'GET',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(transfers => {
                    const tbody = document.getElementById('history-rows');
                    tbody.innerHTML = '';

                    if (!transfers || transfers.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No transfers yet.</td></tr>';
                        return;
                    }


                    transfers.sort((a, b) => new Date(b.date) - new Date(a.date));

                    let html = '';
                    transfers.forEach(t => {
                        const dateObj = new Date(t.date);
                        const dateStr = dateObj.toLocaleDateString() + ' ' + dateObj.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });


                        let isSent = false;


                        if (t.sourceAccount && t.sourceAccount.number === myAccountNumber) {
                            isSent = true;
                        }


                        let amountClass = isSent ? "text-danger" : "text-success";
                        let amountSign = isSent ? "-" : "+";
                        let typeLabel = isSent ? "Transfer Sent" : "Transfer Received";


                        let otherPartyName = "Unknown";
                        if (isSent) {
                            // Si envié, muestro el destinatario
                            if (t.destinationAccount && t.destinationAccount.user) {
                                otherPartyName = "To: " + t.destinationAccount.user.firstName + " " + t.destinationAccount.user.lastName;
                            } else {
                                otherPartyName = "To: External Account";
                            }
                        } else {
                            // Si recibí, muestro el remitente
                            if (t.sourceAccount && t.sourceAccount.user) {
                                otherPartyName = "From: " + t.sourceAccount.user.firstName + " " + t.sourceAccount.user.lastName;
                            } else {
                                otherPartyName = "From: External Account";
                            }
                        }

                        html += `
            <tr>
                <td>
                    <small>${dateStr}</small>
                </td>
                <td>
                    <div class="d-flex flex-column">
                        <span class="fw-bold">${typeLabel}</span>
                        <small class="text-muted">${t.description}</small>
                    </div>
                </td>
                <td>${otherPartyName}</td>
                <td class="${amountClass} fw-bold fs-5">${amountSign}$${t.amount.toFixed(2)}</td>
            </tr>
            `;
                    });
                    tbody.innerHTML = html;
                })
                .catch(err => console.error("Error loading history:", err));
        }


    </script>
</body>

</html>