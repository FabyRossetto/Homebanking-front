<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - NexusBank</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
</head>

<body class="bg-light">

    <nav class="navbar navbar-dark bg-danger shadow-sm">
        <div class="container">
            <a class="navbar-brand fw-bold" href="#">
                <i class="bi bi-shield-lock-fill"></i> Nexus ADMIN
            </a>
            <button onclick="logout()" class="btn btn-sm btn-outline-light">Logout</button>
        </div>
    </nav>

    <div class="container mt-4">
        <h2 class="mb-4">Administration Panel</h2>

        <ul class="nav nav-tabs" id="adminTabs" role="tablist">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#users-tab" type="button">Users
                    Management</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#transfers-tab" type="button">All
                    Transfers</button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="tab" data-bs-target="#cards-tab" type="button">Cards &
                    Expire</button>
            </li>
        </ul>

        <div class="tab-content p-4 bg-white border border-top-0 shadow-sm rounded-bottom">

            <div class="tab-pane fade show active" id="users-tab">
                <div class="row g-2 mb-4">
                    <div class="col-md-4">
                        <input type="text" id="searchEmail" class="form-control" placeholder="Search by Email">
                    </div>
                    <div class="col-md-2">
                        <button onclick="searchUser('email')" class="btn btn-dark w-100">Search Email</button>
                    </div>
                    <div class="col-md-4">
                        <input type="text" id="searchDni" class="form-control" placeholder="Search by DNI">
                    </div>
                    <div class="col-md-2">
                        <button onclick="searchUser('dni')" class="btn btn-dark w-100">Search DNI</button>
                    </div>
                </div>
                <div id="users-result" class="table-responsive"></div>
            </div>

            <div class="tab-pane fade" id="transfers-tab">
                <div class="d-flex gap-3 mb-4">
                    <button onclick="loadAllTransfers()" class="btn btn-primary">Load ALL Transfers</button>

                    <div class="input-group" style="max-width: 300px;">
                        <input type="number" id="searchAmount" class="form-control" placeholder="Filter by Amount">
                        <button onclick="searchTransfersByAmount()" class="btn btn-outline-secondary">Search</button>
                    </div>
                </div>
                <div id="transfers-result" class="table-responsive"></div>
            </div>

            <div class="tab-pane fade" id="cards-tab">
                <div class="mb-4">
                    <label class="form-label">Find expired cards (or expiring soon)</label>
                    <div class="d-flex gap-2" style="max-width: 400px;">
                        <input type="date" id="searchDate" class="form-control">
                        <button onclick="searchCardsByDate()" class="btn btn-warning">Search</button>
                    </div>
                </div>
                <div id="cards-result" class="table-responsive"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_URL = 'https://homebanking-production-2025.up.railway.app';

        // 1. AUTH CHECK
        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem('token');
            if (!token) window.location.href = "index.html";

            // Verify if ADMIN (Using /current endpoint from User Controller)
            fetch(API_URL + '/api/users/current', {
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(user => {
                    // Role verification
                    if (user.role !== 'ADMIN' && !user.email.includes("@admin.com")) {
                        alert("Access Denied: You are not an Administrator.");
                        window.location.href = "accounts.html";
                    }
                })
                .catch(() => window.location.href = "index.html");
        });

        function logout() {
            localStorage.removeItem('token');
            window.location.href = 'index.html';
        }

        // ================= USERS SECTION =================
        function searchUser(type) {
            const token = localStorage.getItem('token');
            let url = "";

            // Routes pointing to /api/admin/...
            if (type === 'email') {
                const val = document.getElementById('searchEmail').value;
                url = `${API_URL}/api/admin/search/email?email=${val}`;
            } else {
                const val = document.getElementById('searchDni').value;
                url = `${API_URL}/api/admin/search/dni?dni=${val}`;
            }

            fetch(url, { headers: { 'Authorization': 'Bearer ' + token } })
                .then(res => {
                    if (!res.ok) throw new Error("User not found");
                    return res.json();
                })
                .then(user => {
                    const container = document.getElementById('users-result');
                    container.innerHTML = `
            <table class="table table-bordered table-striped">
                <thead class="table-dark">
                    <tr><th>ID</th><th>Name</th><th>Email</th><th>DNI</th><th>Actions</th></tr>
                </thead>
                <tbody>
                    <tr>
                        <td><small>${user.id}</small></td>
                        <td>${user.firstName} ${user.lastName}</td>
                        <td>${user.email}</td>
                        <td>${user.nationalId}</td>
                        <td>
                            <button onclick="deleteUser('${user.id}')" class="btn btn-sm btn-danger">
                                HARD DELETE
                            </button>
                        </td>
                    </tr>
                </tbody>
            </table>
        `;
                })
                .catch(err => alert(err.message));
        }

        function deleteUser(id) {
            if (!confirm("ARE YOU SURE? This will permanently delete the user and all their data.")) return;

            const token = localStorage.getItem('token');
            // Route points to /api/admin/users/
            fetch(`${API_URL}/api/admin/users/${id}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        alert("User deleted permanently.");
                        document.getElementById('users-result').innerHTML = "";
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                });
        }

        // ================= TRANSFERS SECTION =================
        function loadAllTransfers() {
            // Route points to /api/admin/transfers/all
            fetchTransfers(`${API_URL}/api/admin/transfers/all`);
        }

        function searchTransfersByAmount() {
            const amount = document.getElementById('searchAmount').value;
            if (!amount) return;
            // This route remains standard user controller
            fetchTransfers(`${API_URL}/api/transfers/search/amount?amount=${amount}`);
        }

        function fetchTransfers(endpoint) {
            const token = localStorage.getItem('token');
            fetch(endpoint, { headers: { 'Authorization': 'Bearer ' + token } })
                .then(res => res.json())
                .then(transfers => {
                    const container = document.getElementById('transfers-result');
                    if (!transfers || transfers.length === 0) {
                        container.innerHTML = "<p>No transfers found.</p>";
                        return;
                    }

                    let rows = transfers.map(t => `
            <tr>
                <td>${t.id}</td>
                <td>$${t.amount}</td>
                <td>${t.sourceAccount ? t.sourceAccount.number : 'N/A'}</td>
                <td>${t.destinationAccount ? t.destinationAccount.number : 'N/A'}</td>
                <td>${t.date}</td>
            </tr>
        `).join('');

                    container.innerHTML = `
            <table class="table table-hover">
                <thead class="table-primary">
                    <tr><th>ID</th><th>Amount</th><th>From</th><th>To</th><th>Date</th></tr>
                </thead>
                <tbody>${rows}</tbody>
            </table>
        `;
                });
        }


        // ================= CARDS SECTION =================

        function searchCardsByDate() {
            const dateInput = document.getElementById('searchDate').value;

            console.log("DATE TO SEND:", dateInput);
            if (!dateInput) return alert("Please select a date.");

            const token = localStorage.getItem('token');

            // Route points to /api/admin/cards/expiration
            fetch(`${API_URL}/api/admin/cards/expiration?date=${dateInput}`, {
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => res.json())
                .then(cards => {
                    console.log("BACKEND:", cards);
                    const container = document.getElementById('cards-result');
                    if (!cards || cards.length === 0) {
                        container.innerHTML = '<div class="alert alert-warning">No cards found expiring on (or before) this date.</div>';
                        return;
                    }

                    let rows = cards.map(c => `
            <tr>
        <td>${c.number}</td>
        <td>${c.type}</td> <td>${c.cardHolder}</td>
        <td>
            <span class="badge bg-secondary">${c.thruDate || c.expirationDate}</span>
        </td>
        <td>
            ${c.type === 'CREDIT' ? `
                <button onclick="updateCardLimit(${c.id})" class="btn btn-sm btn-success me-1">
                    <i class="bi bi-cash"></i> Limit
                </button>
            ` : ''}

            <button onclick="deleteCardAdmin(${c.id})" class="btn btn-sm btn-danger">
                <i class="bi bi-trash"></i> Delete
            </button>
        </td>
    </tr>
`).join('');

                    container.innerHTML = `
            <div class="table-responsive">
                <table class="table table-hover align-middle">
                    <thead class="table-dark">
                        <tr>
                            <th>Number</th>
                            <th>Type</th>
                            <th>Holder</th>
                            <th>Expiration</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
        `;
                })
                .catch(err => {
                    console.error(err);
                    alert("Error fetching cards.");
                });
        }

        // --- ACTION FUNCTIONS (ADMIN) ---

        // 1. UPDATE LIMIT
        function updateCardLimit(cardId) {
            const amountStr = prompt("Enter new CREDIT limit for this card:");
            if (!amountStr) return;

            const amount = parseFloat(amountStr);
            if (isNaN(amount) || amount <= 0) return alert("Invalid amount.");

            const token = localStorage.getItem('token');

            const params = new URLSearchParams();
            params.append('cardId', cardId);
            params.append('amount', amount);

            // Route points to /api/admin/cards/update-limit
            fetch(`${API_URL}/api/admin/cards/update-limit`, {
                method: 'PUT',
                headers: {
                    'Authorization': 'Bearer ' + token,
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: params
            })
                .then(res => {
                    if (res.ok) {
                        alert("Limit updated successfully!");
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                })
                .catch(err => alert("Connection error"));
        }

        // 2. HARD DELETE CARD (ADMIN)
        function deleteCardAdmin(cardId) {
            if (!confirm("DANGER: This will permanently delete this card from the database. Continue?")) return;

            const token = localStorage.getItem('token');

            // Route points to /api/admin/cards/{id}
            fetch(`${API_URL}/api/admin/cards/${cardId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Card permanently deleted.");
                        searchCardsByDate();
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                })
                .catch(err => alert("Connection error"));
        }

        // 3. HARD DELETE ACCOUNT (ADMIN)
        function deleteAccountAdmin(accountId) {
            if (!confirm("CRITICAL: Delete this account and all its transactions?")) return;

            const token = localStorage.getItem('token');

            // Route points to /api/admin/accounts/{id}
            fetch(`${API_URL}/api/admin/accounts/${accountId}`, {
                method: 'DELETE',
                headers: { 'Authorization': 'Bearer ' + token }
            })
                .then(res => {
                    if (res.ok) {
                        alert("Account deleted.");
                    } else {
                        res.text().then(msg => alert("Error: " + msg));
                    }
                });
        }
    </script>
</body>

</html>